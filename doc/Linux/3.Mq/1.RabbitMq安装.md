# RabbitMq安装



## 1 RabbitMQ单点安装

### 1.1 环境

> Linux：centos 7
>
> Erlang：22.0.x
>
> RabbitMQ：rabbitmq-server-3.7.x

### 1.2 配置yum源

打开/etc/yum.repos.d/CentOS-Base.repo，在结尾增加如下数据。

```shell
[rabbitmq-erlang]
name=rabbitmq-erlang
baseurl=https://dl.bintray.com/rabbitmq-erlang/rpm/erlang/22/el/7
gpgcheck=1
gpgkey=https://dl.bintray.com/rabbitmq/Keys/rabbitmq-release-signing-key.asc
repo_gpgcheck=0
enabled=1

[bintray-rabbitmq-server]
name=bintray-rabbitmq-rpm
baseurl=https://dl.bintray.com/rabbitmq/rpm/rabbitmq-server/v3.7.x/el/7/
gpgcheck=0
repo_gpgcheck=0
enabled=1
```

新增文件数据后，要刷新缓存。

```shell
yum makecache
```

### 1.3 安装依赖包

```shell
yum install build-essential openssl openssl-devel unixODBC unixODBC-devel make gcc gcc-c++ kernel-devel m4 ncurses-devel tk tc xz
```
> * build-essential
>
>   提供编译程序必须软件包的列表信息，编译程序有了这个软件包，就可以知道头文件和库函数的位置。
>
> * openssl
>
>   提供了产生各种公开密钥对和对称密钥的方法、函数和应用程序，并提供了对公钥和私钥的DER编解码功能。
>
> * openssl-devel
>
>   第三方软件开发时使用的Lib包，用于编译的时候连接的库等。
>
> * unixODBC
>
>   linux在平台上实现的ODBC驱动管理器(Driver Manager)，当应用程序调用C函数SQLDriverConnect时，会依据参数以及ODBC的配置文件内容去调用具体的ODBC驱动程序动态库。
>
> * kernel-devel
>
>   只包含用于内核开发环境所需的内核头文件以及Makefile，提供内核的C header 来编译程序。

~~为什么编译：待加~~

### 1.4 安装服务命令

```shell
yum install rabbitmq-server
```

### 1.5 配置文件

```shell
vim /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.5/ebin/rabbit.app
```

比如修改密码、配置等等，例如：loopback_users中的<<"guest">>，只保留guest。

### 1.6 安装管理插件

```shell
rabbitmq-plugins enable rabbitmq_management
```

访问地址：http://本地ip:15672/

### 1.7 服务指令

> 服务启动

```shell
systemctl start rabbitmq-server #Centos7
service rabbitmq-server start #Centos6
```

> 开机自启

```SHELL
systemctl enable rabbitmq-server #Centos7
service rabbitmq-server enable #Centos6
```

> 服务停止

```shell
rabbitmqctl stop_app
```

------

> 添加admin用户

```shell
rabbitmqctl add_user admin admin
```

> 用户授权

```shell
rabbitmqctl set_permissions -p "/" admin ".*" ".*" ".*"
```

> 修改用户角色为管理员角色

```shell
rabbitmqctl set_user_tags admin administrator
```

> 查看用户

```shell
rabbitmqctl list_permissions
```

------

> 查看有没有rabbit进程

```shell
ps -ef | grep rabbit
```

> 查看端口有没有开放

```shell
lsof -i:5672
```



## 2 RabbitMQ集群安装

### 2.1 环境

> Linux：centos 7
>
> Erlang：22.0.x
>
> RabbitMQ：rabbitmq-server-3.7.x

### 2.2 配置yum源

打开/etc/yum.repos.d/CentOS-Base.repo，在结尾增加如下数据。

```shell
[rabbitmq-erlang]
name=rabbitmq-erlang
baseurl=https://dl.bintray.com/rabbitmq-erlang/rpm/erlang/22/el/7
gpgcheck=1
gpgkey=https://dl.bintray.com/rabbitmq/Keys/rabbitmq-release-signing-key.asc
repo_gpgcheck=0
enabled=1

[bintray-rabbitmq-server]
name=bintray-rabbitmq-rpm
baseurl=https://dl.bintray.com/rabbitmq/rpm/rabbitmq-server/v3.7.x/el/7/
gpgcheck=0
repo_gpgcheck=0
enabled=1
```

新增文件数据后，要刷新缓存。

```shell
yum makecache
```

### 2.3 安装依赖包

```shell
yum install build-essential openssl openssl-devel unixODBC unixODBC-devel make gcc gcc-c++ kernel-devel m4 ncurses-devel tk tc xz
```

### 2.4 安装服务命令

```shell
yum install rabbitmq-server
```

### 2.5 修改集群用户与连接心跳检测

> 修改/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.5/ebin/rabbit.app文件中的配置数据。
>
> - 修改：loopback_users中的<<"guest">>，只保留guest。
> - 修改：heartbeat为1。

### 2.6 安装管理插件

```shell
/etc/init.d/rabbitmq-server start stop status restart
rabbitmq-plugins enable rabbitmq_management
```

访问地址：http://192.168.1.76:15672/（可验证单个节点是否安装成功）

### 2.7 文件同步

> 选择76、77、78任意一个节点为Master（这里选择76为Master），也就是说我们需要把76的Cookie文件同步到77、78节点上去，进入/var/lib/rabbitmq目录下，把/var/lib/rabbitmq/.erlang.cookie文件的权限进行设定setfacl -m u:rabbitmq:rwx /var/lib/rabbitmq/.erlang.cookie；然后把.erlang.cookie文件copy到各个节点下。

```
/etc/init.d/rabbitmq-server stop
scp /var/lib/rabbitmq/.erlang.cookie 到192.168.1.77和192.168.1.78中 #进入目录修改权限；远程copy77、78节点
```

